script que o datto rmm usa:

<# disk SMART monitor :: build 9/seagull, november 2025
   script variables: usrAlertOnUnknown/Bln :: usrThreshold/str

   this script, like all datto RMM Component scripts unless otherwise explicitly stated, is the copyrighted property of Datto, Inc.;
   it may not be shared, sold, or distributed beyond the Datto RMM product, whole or in part, even with modifications applied, for 
   any reason. this includes on reddit, on discord, or as part of other RMM tools. PCSM and VSAX stand as exceptions to this rule.

   component icon uses work from vectorsmarket115/flaticon.com
   	
   the moment you edit this script it becomes your own risk and support will not provide assistance with it.#>

#region Functions & variables ---------------------------------------------------------------------------

[int]$varAlert=0

function postMessage ($message) {
    write-host '<-End Diagnostic->'
    write-host '<-Start Result->'
    write-host "Status=$message"
    write-host '<-End Result->'
}

write-host '<-Start Diagnostic->'

if ([string]::IsNullOrEmpty($env:usrThreshold)) {
    write-host "- usrThreshold variable unset: Setting to zero."
    write-host "  (Delete and re-add the Component from the ComStore if no usrThreshold variable is surfaced.)"
    $env:usrThreshold=0
}

#region Loop through drives with letters ----------------------------------------------------------------

[int]$varCounter=0
$arrDisks=@{}
Get-Volume | ? {$_.DriveLetter} | % { 
    $varDriveLetter=$_.driveLetter
    Get-Partition | ? {$_.AccessPaths -contains "$varDriveLetter`:\"} | % {
        Get-Disk -Number $_.DiskNumber | % {
            if ($_.BusType -ne 'USB') {
                if ($null -eq ($_.serialNumber).trim()) {
                    $varCounter++
                    $varDriveSerial="VirtualDisk$varCounter"
                    write-host ": Drive $varDriveLetter does not correspond to a disk with a serial number."
                    write-host "  This disk is likely virtual and lacks any health data to post."
                    write-host "  Checks against Get-PhysicalDisk will be skipped."
                } else {
                    $varDriveSerial=($_.serialNumber).trim()
                }

                #if this disk is new, add its value to the table; otherwise just add its drive letter
                if ($arrDisks[$varDriveSerial]) {
                    $arrDisks[$varDriveSerial].DriveLetter="$($arrDisks[$varDriveSerial].DriveLetter), $varDriveLetter`:\"
                    return
                } else {
                    $arrDisks.add($varDriveSerial,[PSCustomObject]@{DriveLetter="$varDriveLetter`:\"})
                }

                #compile a table :: gather get-disk data
                $arrDisks[$varDriveSerial] | Add-Member -Name "Descriptor"          -type noteProperty -Value "$($_.friendlyName) ($(($_.serialNumber).trim()))"
                $arrDisks[$varDriveSerial] | Add-Member -Name "GDOperationalStatus" -type noteProperty -Value $_.operationalStatus 
                $arrDisks[$varDriveSerial] | Add-Member -Name "GDHealthStatus"      -type noteProperty -Value $_.healthStatus

                #add additional disk wear information from get-storageReliabilityCounter
                get-physicaldisk | ? {($_.serialNumber).trim() -match $varDriveSerial} | % {

                    #gather get-physicalDisk data
                    $arrDisks[$varDriveSerial] | Add-Member -Name "GPDOperationalStatus" -type noteProperty -Value $_.operationalStatus 
                    $arrDisks[$varDriveSerial] | Add-Member -Name "GPDHealthStatus"      -type noteProperty -Value $_.healthStatus
                
                    #gather gpd.gsrc data
                    $_ | get-storageReliabilityCounter | % {
                        $arrDisks[$varDriveSerial] | Add-Member -Name "Wear" -type noteProperty -Value $_.wear

                        if (!($_.writeErrorsTotal)) {
                            $arrDisks[$varDriveSerial] | Add-Member -Name "Total Write Errors" -type noteProperty -Value 0
                        } else {
                            $arrDisks[$varDriveSerial] | Add-Member -Name "Total Write Errors" -type noteProperty -Value $_.writeErrorsTotal
                            if ([int]$_.writeErrorsTotal -gt [int]$env:usrThreshold) {
                                write-host "! ALERT: Write-errors count ($($_.writeErrorsTotal)) breaches threshold ($env:usrThreshold)"
                                $varAlert++
                            }
                        }

                        if (!($_.readErrorsTotal)) {
                            $arrDisks[$varDriveSerial] | Add-Member -Name "Total Read Errors" -type noteProperty -Value 0
                        } else {
                            $arrDisks[$varDriveSerial] | Add-Member -Name "Total Read Errors" -type noteProperty -Value $_.readErrorsTotal
                            if ([int]$_.readErrorsTotal -gt [int]$env:usrThreshold) {
                                write-host "! ALERT: Read-errors count ($($_.readErrorsTotal)) breaches threshold ($env:usrThreshold)"
                                $varAlert++
                            }
                        }
                    }
                }
            }
        }
    }
}

write-host "--------------------------------"
$arrDisks.values | fl
write-host "--------------------------------"

#region Calculate alert status --------------------------------------------------------------------------

if (($arrDisks.values | ? {$_.GDHealthStatus}) -notmatch 'Healthy|Unknown') {
    write-host "! ALERT: Disk health status (Get-Disk) does not match 'Healthy' or 'Unknown'"
    $varAlert++
}

if ($env:usrAlertOnUnknown) {
    if (($arrDisks.values | ? {$_.GDHealthStatus}) -match 'Unknown') {
        write-host "! ALERT: Disk health status (Get-Disk) matches 'Unknown' and usrAlertOnUnknown is enabled"
        $varAlert++
    }
}

if (($arrDisks.values | ? {$_.GPDHealthStatus}) -notmatch 'Healthy|Unknown') {
    write-host "! ALERT: Disk health status (Get-PhysicalDisk) does not match 'Healthy' or 'Unknown'"
    $varAlert++
}

if ($env:usrAlertOnUnknown) {
    if (($arrDisks.values | ? {$_.GPDHealthStatus}) -match 'Unknown') {
        write-host "! ALERT: Disk health status (Get-PhysicalDisk) matches 'Unknown' and usrAlertOnUnknown is enabled"
        $varAlert++
    }
}

if (($arrDisks.values | ? {$_.GPDOperationalStatus}) -match 'Fail') {
    write-host "! ALERT: Disk operational status (Get-PhysicalDisk) matches 'Fail'"
    $varAlert++
}

#region Alert -------------------------------------------------------------------------------------------

if ($varAlert -gt 0) {
    postMessage "One or more disks is reporting potential issues. Check diagnostic."
    exit 1
} else {
    postMessage "All disks reporting OK"
}